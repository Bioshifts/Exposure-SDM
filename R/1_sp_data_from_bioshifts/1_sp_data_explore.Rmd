---
title: "Get species data for SDMs"
author: "Brunno F Oliveira & Bioshifts group"
date: "Last compiled on `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_float: true
        number_sections: true
---

# *Setup*

```{r setup, message = FALSE, warning = FALSE}

rm(list=ls())
gc()

list.of.packages <- c("dplyr", "here", "tidyr","data.table", "ggplot2", "pbapply")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages)) install.packages(new.packages)

sapply(list.of.packages, require, character.only = TRUE)

```

# *Load species list*

This is the list of species from Bioshifts v1 considering only:
1 - latitudinal shifts
2 - marine (except marine birds) or terrestrial shifts (removing species shifts were coded as aquatic or fresh water)
3 - species with > 30 GBIF occurrence records. For the GBIF records we used only the basis of record "HUMAN_OBSERVATION",  "OBSERVATION" or "OCCURRENCE", and occurrences recorded after 1901, occurrences flagged as has no issue.

```{r}
computer = "personal"

source(here("R/settings.R"))
source(here("R/Clean_names.R"))

N_OCC <- read.csv(here("Data/n_occ.csv"))
splist <- read.csv(here("Data/Bioshifts/splist_v3_hamonized.csv"), header = T)

```


# *N species*
```{r}


# remove duplicated sp_names
splist <- splist %>%
    dplyr::select(scientificName,kingdom,phylum,class,order,family,db,db_code) %>%
    filter(!duplicated(scientificName))

# original N species v1
nrow(splist)

# N species with occurrences in GBIF after removing the species mentioned above
gbifocc <- N_OCC %>%
    dplyr::select(scientificName,kingdom,phylum,class,order,family,db,N_OCC,Eco,Group) %>%
    filter(!duplicated(scientificName))
N_OCC <- gbifocc %>%
    filter(N_OCC > 30)
nrow(N_OCC)

all(N_OCC$scientificName %in% splist$scientificName)

# By Eco and group
## Terrestrials
N_OCC %>%
    filter(Eco == "Ter") %>%
    group_by(Group) %>%
    tally() %>%
    arrange(by = desc(n))

## Marine
N_OCC %>%
    filter(Eco == "Mar") %>%
    group_by(Group) %>%
    tally() %>%
    arrange(by = desc(n))

table(N_OCC$Eco)

####################
#### Plot
ggplot(N_OCC, aes(x = Group))+
    geom_bar()+
    theme_classic()+
    # coord_flip()+
    ylab("N species")+xlab("")+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    facet_wrap(.~Eco, scales = "free")

```


# *N shifts*
```{r}
bioshifts <- read.csv(here::here(Bioshifts_dir, Bioshifts_DB_v3), header = T)
bioshifts <- bioshifts %>%
    filter(Type == "LAT") %>% # Use only latitudinal shifts
    filter(Eco == "Ter" & (MIDPOINT_firstperiod_v3 >= (temporal_range_env_data("Ter")[1] + n_yr_bioclimatic)) | # Shifts Marine or Terrestrial + within time period of the environmental data
               (Eco == "Mar" & (MIDPOINT_firstperiod_v3 >= (temporal_range_env_data("Mar")[1] + n_yr_bioclimatic)))) 

bioshifts$sp_name_v3 <- gsub("_"," ",bioshifts$sp_name_v3)
bioshifts$sp_name_v3 <- Clean_Names(bioshifts$sp_name_v3)

# add taxonomy
splist <- read.csv(here("Data/Bioshifts/splist_v3_hamonized.csv"), header = T)
bioshifts <- merge(bioshifts[,!names(bioshifts) %in% names(splist)], splist,
                   by.x = "sp_name_v3",
                   by.y = "original_name",
                   all.x = TRUE)
bioshifts %>%
    group_by(Group,Eco,Type,Param) %>%
    tally()

####################
#### Plot
ggplot(bioshifts, aes(x = Group))+
    geom_bar()+
    theme_classic()+
    # coord_flip()+
    ylab("N shifts")+xlab("")+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    facet_wrap(.~Eco, scales = "free")
```

Select only groups with shift for all the three edges
```{r}

ggplot(bioshifts %>%
           filter(Eco == "Ter"), 
       aes(x = Group))+
    ggtitle("Terrestrial")+
    geom_bar()+
    theme_classic()+
    # coord_flip()+
    ylab("N shifts")+xlab("")+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    facet_grid(.~Param, scales = "free")

ggplot(bioshifts %>%
           filter(Eco == "Mar"), 
       aes(x = Param))+
    ggtitle("Marine")+
    geom_bar()+
    theme_classic()+
    coord_flip()+
    ylab("N shifts")+xlab("")+
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    facet_wrap(.~Group, scales = "free")

```

