---
title: "Get species data for SDMs"
author: "Brunno F Oliveira & Bioshifts group"
date: "Last compiled on `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_float: true
        number_sections: true
---

# Setup

```{r setup, message = FALSE, warning = FALSE}

rm(list=ls())
gc()

list.of.packages <- c("stringr", "rgbif", "parallel", "pbapply", "raster", "dplyr", "here", 
                      "data.table", "ggplot2", "readxl", "knitr",
                      "sqldf","RSQLite", "scales")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]

if(length(new.packages)) install.packages(new.packages)

sapply(list.of.packages, require, character.only = TRUE)

```

# Load parameters
```{r}

source(here::here("R/settings.R"))

range_env_data <- sapply(temporal_range_env_data, function(x){
    c(min(x),max(x))
})
range_env_data <- c(min(range_env_data),max(range_env_data))

```

# Load functions
```{r }

source(here::here("R/my_functions.R"))

```

# Load species list
```{r}

splist <- read.csv(here::here("Data/splist.csv"), header = T)

```

## Filter species with GBIF data
```{r}

splist <- splist[which(splist$db == "gbif"),]

```

# Load raw bioshifts
```{r }
# Load v1
biov1 <- read.csv(here::here("Data/biov1_fixednames.csv"), header = T)
# Fix references in biov1
biov1$Article_ID <- gsub("[^0-9.-]", "", biov1$Article_ID)
biov1$Article_ID <- as.numeric(biov1$Article_ID)
biov1 <- biov1[-which(biov1$valid_species_name=="no"),]
biov1$sp_name_std_v1 <- gsub("_"," ",biov1$sp_name_std_v1)
# # "T" "M"
# unique(biov1$group)
# # "vertebrate"         "vascular.plant"     "other.animal"  
# # "fungi"              "algae"              "virus" 
# # "bacteria"           "non.vascular.plant"

# Fishes are those from Class Actinopterygii
# Class Actinopterygii + ECO T = freshwater fish
# Class Actinopterygii + ECO M = marine fish
# Sharks are those from Class Chondrichthyes


# Load v2 
biov2 <- read.csv(here::here("Data/biov2_fixednames.csv"), header = T)
biov2$Scientific.Name <- gsub(" ","_",biov2$Scientific.Name)
biov2$sp_name_std_v2 <- gsub("_"," ",biov2$sp_name_std_v2)

# unique(biov2$Ecosystem.Type)
# # "terrestrial" "marine"      "aquatic"
# unique(biov2$Habitat.Type)
# # Many
# unique(biov2$Taxonomic.Group)
# # "Bird"                                "Insect"                             
# # "Amphibian"                           "Mammal"                             
# # "Spider"                              "Plant"                              
# # "Sea anemones and corals"             "Polychaetes"                        
# # "Molluscs"                            "NA"                                 
# # "Crustacean"                          "Starfish"                           
# # "Ascidians tunicates and sea squirts" "Fish"                               
# # "Sea urchin"                          "Crinoid"                            
# # "Sea cucumber"                        "Reptile"                            
# # "Brittle stars"                       "Centipedes"                         
# # "Millipedes"                          "Hydrozoa" 

```

## Remove species identified to the genus level or cf.

```{r }
if(any(grep("sp[.]",biov1$sp_reported_name_v1))){
    biov1 <- biov1 %>% filter(!grepl("sp[.]",sp_reported_name_v1))
}
if(any(grep("sp[.]",biov1$sp_name_std_v1))){
    biov1 <- biov1 %>% filter(!grepl("sp[.]",sp_name_std_v1))
}
if(any(grep("cf[.]",biov1$sp_reported_name_v1))){
    biov1 <- biov1 %>% filter(!grepl("cf[.]",sp_reported_name_v1))
}
if(any(grep("cf[.]",biov1$sp_name_std_v1))){
    biov1 <- biov1 %>% filter(!grepl("cf[.]",sp_name_std_v1))
}

if(any(grep("sp[.]",biov2$sp_reported_name_v2))){
    biov2 <- biov2 %>% filter(!grepl("sp.",sp_reported_name_v2))
}
if(any(grep("sp[.]",biov2$sp_name_std_v2))){
    biov2 <- biov2 %>% filter(!grepl("sp[.]",sp_name_std_v2))
}
if(any(grep("cf[.]",biov2$sp_reported_name_v2))){
    biov2 <- biov2 %>% filter(!grepl("cf[.]",sp_reported_name_v2))
}
if(any(grep("cf[.]",biov2$sp_name_std_v2))){
    biov2 <- biov2 %>% filter(!grepl("cf[.]",sp_name_std_v2))
}
if(any(grep("cf[.]",biov2$Scientific.Name))){
    biov2 <- biov2 %>% filter(!grepl("cf[.]",Scientific.Name))
}

```

## Filter LAT / ELE shifts
```{r}
biov1 <- biov1 %>%
    mutate(
        Type = case_when(
            Type=="HOR" ~ "LAT",
            TRUE ~ as.character(Type))) %>% # get LAT from LON
    filter(Type %in% c("ELE","LAT"))  # Use LAT ELE shifts

biov2 <- biov2 %>%
    mutate(
        Dimension = case_when(
            Dimension=="latitude" ~ "LAT",
            Dimension=="elevation" ~ "ELE",
            TRUE ~ as.character(Dimension))) %>% 
    filter(Dimension %in% c("ELE","LAT")) # Use LAT ELE shifts

```

## Classify species
```{r }

# Class species as Terrestrial, Marine or Freshwater

Terv1 <- unique(biov1$sp_name_std_v1[which(biov1$ECO == "T")])
Terv2 <- unique(biov2$sp_name_std_v2[which(biov2$Ecosystem.Type == "terrestrial")])
Terrestrials = unique(c(Terv1,Terv2))

Mar1 <- unique(biov1$sp_name_std_v1[which(biov1$ECO == "M")])
Mar2 <- unique(biov2$sp_name_std_v2[which(biov2$Ecosystem.Type == "marine")])
Marine = unique(c(Mar1,Mar2))

Aquatic = unique(biov2$sp_name_std_v2[which(biov2$Ecosystem.Type == "aquatic")])

# Freshwater fish
FFishv1 <- unique(biov1$sp_name_std_v1[biov1$Class == "Actinopterygii" & biov1$ECO == "T"])
FFishv2 <- unique(biov2$sp_name_std_v2[biov2$Taxonomic.Group == "Fish" & biov2$Ecosystem.Type == "terrestrial"])
FFish = unique(c(FFishv1,FFishv2))
# Marine fish
MFishv1 <- unique(biov1$sp_name_std_v1[biov1$Class == "Actinopterygii" & biov1$ECO == "M"])
MFishv2 <- unique(biov2$sp_name_std_v2[biov2$Taxonomic.Group == "Fish" & biov2$Ecosystem.Type == "marine"])
MFish = unique(c(MFishv1,MFishv2))

splist$ECO = NA
splist$ECO[which(splist$scientificName %in% Terrestrials)] <- "T"
splist$ECO[which(splist$scientificName %in% Marine)] <- "M"
splist$ECO[which(splist$scientificName %in% Aquatic)] <- "A"

biov1$ECO = NA
biov1$ECO[which(biov1$sp_name_std_v1 %in% Terrestrials)] <- "T"
biov1$ECO[which(biov1$sp_name_std_v1 %in% Marine)] <- "M"
biov1$ECO[which(biov1$sp_name_std_v1 %in% Aquatic)] <- "A"

biov2$ECO = NA
biov2$ECO[which(biov2$sp_name_std_v2 %in% Terrestrials)] <- "T"
biov2$ECO[which(biov2$sp_name_std_v2 %in% Marine)] <- "M"
biov2$ECO[which(biov2$sp_name_std_v2 %in% Aquatic)] <- "A"

splist$Group = NA
splist$Group[which(splist$class == "Holothuroidea")] <- "Sea cucumber"
splist$Group[which(splist$class == "Aves")] <- "Bird"
splist$Group[which(splist$class == "Insecta")] <- "Insect"
splist$Group[which(splist$class == "Mammalia")] <- "Mammal"
splist$Group[which(splist$class == "Arachnida")] <- "Spider"
splist$kingdom[which(splist$kingdom == "Viridiplantae")] <- "Plantae"
splist$kingdom[which(splist$phylum == "Tracheophyta")] <- "Plantae"
splist$Group[which(splist$kingdom == "Plantae")] <- "Plant"
splist$Group[which(splist$class == "Hydrozoa")] <- "Hydrozoa"
splist$Group[which(splist$class == "Anthozoa")] <- "Sea anemones and corals"
splist$Group[which(splist$class == "Polychaeta")] <- "Polychaetes"
splist$Group[which(splist$phylum == "Mollusca")] <- "Molluscs"
splist$Group[which(splist$class == "Malacostraca")] <- "Crustacean"
splist$Group[which(splist$class == "Hexanauplia")] <- "Crustacean"
splist$Group[which(splist$class == "Maxillopoda")] <- "Crustacean"
splist$Group[which(splist$class == "Ostracoda")] <- "Crustacean"
splist$Group[which(splist$class == "Branchiopoda")] <- "Crustacean"
splist$Group[which(splist$class == "Asteroidea")] <- "Starfish"
splist$Group[which(splist$class == "Ascidiacea")] <- "Ascidians tunicates and sea squirts"
splist$class[which(splist$class == "Actinopteri")] <- "Actinopterygii"
splist$Group[which(splist$class == "Actinopterygii")] <- "Fish"
splist$Group[which(splist$class == "Elasmobranchii")] <- "Fish"
splist$Group[which(splist$order == "Perciformes")] <- "Fish"
splist$Group[which(splist$class == "Chondrichthyes")] <- "Fish"
splist$Group[which(splist$class == "Holocephali")] <- "Fish"
splist$Group[which(splist$class == "Cephalaspidomorphi")] <- "Fish"
splist$Group[which(splist$class == "Echinoidea")] <- "Sea urchin"
splist$Group[which(splist$class == "Crinoidea")] <- "Crinoid"
splist$Group[which(splist$class == "Holothuroidea")] <- "Sea cucumber"
splist$Group[which(splist$class == "Reptilia")] <- "Reptile"
splist$Group[which(splist$order == "Squamata")] <- "Reptile"
splist$Group[which(splist$class == "Ophiuroidea")] <- "Brittle stars"
splist$Group[which(splist$class == "Chilopoda")] <- "Centipedes"
splist$Group[which(splist$class == "Diplopoda")] <- "Millipedes"
splist$Group[which(splist$class == "Amphibia")] <- "Amphibian"
splist$Group[which(splist$kingdom == "Fungi")] <- "Fungi"
splist$Group[which(splist$order == "Balanomorpha")] <- "Barnacles"
splist$Group[which(splist$phylum == "Nematoda")] <- "Nematodes"
splist$Group[which(splist$class == "Myxini")] <- "Hagfish"
splist$Group[which(splist$kingdom == "Chromista")] <- "Chromista"

```


# Look at the distribution of shift values per year before filtering the data
```{r}
biov1_raw <- as_tibble(biov1) %>%
    dplyr::select(START, Type)

biov2_raw <- as_tibble(biov2) %>%
    dplyr::select(Start.Year, Dimension)


ggplot(biov1_raw, aes(START, fill = Type)) +
    ggtitle("v1")+
    geom_histogram(alpha = .5) +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))

ggplot(biov1_raw, aes(START, colour = Type)) +
    ggtitle("v1")+
    stat_ecdf(geom = "step") +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))


ggplot(biov2_raw, aes(Start.Year, fill = Dimension)) +
    ggtitle("v2")+
    geom_histogram(alpha = .5) +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))

ggplot(biov2_raw, aes(Start.Year, colour = Dimension)) +
    ggtitle("v2")+
    stat_ecdf(geom = "step") +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))

#############
# Summary 
# N Studies 
rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(Type))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(Dimension))))

rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     dplyr::group_by(Type) %>%
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(Type))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     dplyr::rename(Type = Dimension) %>%
                     group_by(Type) %>%
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(Type))))

rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     dplyr::group_by(ECO) %>%
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(ECO))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     dplyr::group_by(ECO) %>%
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(ECO))))
```

# Filter shifts within the temporal range of the environmental data
```{r}

biov1 <- biov1 %>%
    filter(START >= range_env_data[1]) # shifts within the range of environmental data

biov2 <- biov2 %>%
    filter(Start.Year >= range_env_data[1]) # shifts within the range of environmental data

ggplot(biov1, aes(START, fill = Type)) +
    ggtitle("v1")+
    geom_histogram(alpha = .5) +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))

ggplot(biov2, aes(Start.Year, fill = Dimension)) +
    ggtitle("v2")+
    geom_histogram(alpha = .5) +
    geom_vline(xintercept = range_env_data[1], color = "Green")+
    theme(plot.title = element_text(hjust = 0.5))


#############
# Summary 
# N Studies 
rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(Type))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(Dimension))))

rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     dplyr::group_by(Type) %>%
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(Type))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     dplyr::rename(Type = Dimension) %>%
                     group_by(Type) %>%
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(Type))))

rbind(data.frame(Version = "v1",
                 biov1 %>% 
                     dplyr::group_by(ECO) %>%
                     summarise(N_Studies = length(unique(Article_ID)),
                               N_species = length(unique(sp_name_std_v1)),
                               N_shifts = length(ECO))),
      data.frame(Version = "v2",
                 biov2 %>% 
                     dplyr::group_by(ECO) %>%
                     summarise(N_Studies = length(unique(Paper.ID)),
                               N_species = length(unique(sp_name_std_v2)),
                               N_shifts = length(ECO))))
```

# Get species list with species we can work with given the conditions above
```{r}

sp_work <- unique(biov1$sp_name_std_v1, biov2$sp_name_std_v2)

splist <- splist %>% dplyr::filter(scientificName %in% sp_work)

# N species possible to work is 
length(unique(splist$scientificName))

```


# N occurrences GBIF

Retrieve a summary table with N occurrence per species.
We only retrieve N occurrences for records based:
1) "HUMAN_OBSERVATION", "LITERATURE", "LIVING_SPECIMEN", "OBSERVATION", "PRESERVED_SPECIMEN", "OCCURRENCE"
2) from which there was coordinates recorded
3) Registered after 1979 (limit is 2022)

```{r eval=FALSE}

# basisOfRecord = c("HUMAN_OBSERVATION", "LITERATURE",
#                   "LIVING_SPECIMEN", "OBSERVATION",
#                   "PRESERVED_SPECIMEN", "OCCURRENCE")
# 
# cl <- makeCluster(20)
# clusterExport(cl, c("splist","basisOfRecord","range_env_data"))
# 
# N_OCC <- pbsapply(1:length(splist$db_code), function(i) {
# 
#     code <- gsub("GBIF:","",splist$db_code[i])
# 
#     records <- sapply(basisOfRecord, function(b) {
#         rgbif::occ_count(taxonKey = code,
#                          georeferenced = TRUE,
#                          basisOfRecord = b,
#                          from = range_env_data[1], to = range_env_data[2]) # limit of climate data
#     })
# 
#     sum(records)
# }
# ,
# cl = cl)
# 
# stopCluster(cl)
# 
# # Took 4min FRB
# 
# length(N_OCC) == length(splist$scientificName)
# 
# N_OCC <- data.frame(splist, n_occ = N_OCC)
# 
# write.csv(N_OCC, here::here("Data/n_occ.csv"), row.names = F)

N_OCC <- read.csv(here::here("Data/n_occ.csv"))

```

# Create a SQL Database with species Info (GBIF + Taxonomy)

```{r eval=FALSE}

# my_db_file <- here::here("Data/BioshiftsExposure.sqlite")
# my_db <- src_sqlite(my_db_file, create = TRUE)

# driver
drv <- dbDriver("SQLite") 
# connect
db <- dbConnect(drv, my_db_file) 

dbWriteTable(conn=db, name="SpInfo", N_OCC, overwrite = TRUE)

# disconnect
DBI::dbDisconnect(db)

rm(N_OCC)



```

# Stats
## N species by group
```{r}

my_db_file <- here::here("Data/BioshiftsExposure.sqlite")

# driver
drv <- dbDriver("SQLite") 
# connect
db <- dbConnect(drv, my_db_file) 

N_OCC <- dbReadTable(conn=db, name="SpInfo")

# disconnect
DBI::dbDisconnect(db)

# N Species by group
tmp <- data.frame(table(N_OCC$Group[which(N_OCC$n_occ>30)]))
tmp$Var1 <- factor(tmp$Var1, levels = tmp$Var1[order(tmp$Freq)])

ggplot(tmp, aes(x = Var1, y = Freq))+
    geom_col()+
    coord_flip()+
    theme_classic()+
    ylab("N species")+xlab("")

```

## N occurrences by group
```{r fig.height=4, fig.width=10}

toplot <- N_OCC %>%
    filter(n_occ > 30) %>%
    group_by(kingdom, Group) %>%
    summarise(n_occ = sum(n_occ))

toplot$class <- factor(toplot$Group, levels = toplot$Group[order(toplot$n_occ)])

# Occ by Class
ggplot(toplot, aes(x = Group, y = n_occ))+
    geom_col()+
    theme_classic()+
    # coord_flip()+
    ylab("N species")+xlab("Class")+
    theme(axis.text.x = element_text(angle = 45, hjust=1))

```

## N species by ECO
```{r fig.width=8, fig.height=6}

toplot <- N_OCC %>%
    group_by(ECO, Group) %>%
    summarise(n_sps = length(unique(scientificName)))
toplot$n_sps <- as.numeric(toplot$n_sps)

# Occ by ECO
ggplot(toplot, aes(x = ECO, y = n_sps))+
    geom_col(fill = "white", color = "black")+
    theme_classic()+
    ylab("N species")+xlab("Habitat")+
    facet_grid(scales = "free", space = "free", cols = vars(Group))+
    theme(strip.text.x = element_text(angle = 90))

```


```{r}

# % bioshift with occ
bio <- read.csv(here::here("Data/n_occ.csv"))
bio <- data.frame(table(bio$class))
names(bio) <- c("Class","Bioshifts_Freq")

gbifocc <- data.frame(table(N_OCC$class))
names(gbifocc) <- c("Class","GBIF_Freq")

bio <- merge(bio, gbifocc)
bio$percent = paste(round((bio$GBIF_Freq/bio$Bioshifts_Freq)*100,2),"%")

melted <- reshape::melt(bio[,c(1:3)], id="Class")
melted <- merge(melted, bio[,c(1,4)])
melted$percent[which(melted$variable == "GBIF_Freq")] = NA

keep <- unique(melted$Class[which(melted$value > 20)])
toplot = melted[which(melted$Class %in% keep),]
toplot$Class <- factor(toplot$Class, levels = unique(toplot$Class[order(toplot$value)]))

ggplot(toplot, 
       aes(x = Class, y = value, fill = variable))+
    geom_bar(stat="identity",position = "identity", alpha = .5) +
    geom_text(aes(label=percent),
              stat='identity', size = 3, hjust = "inward")+
    coord_flip()+
    ylab("N species")+
    theme_classic()+
    theme(legend.position="bottom",
          legend.title = element_blank()) 

```

